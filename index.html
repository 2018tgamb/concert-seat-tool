<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式音樂會座位劃位工具</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look (Inter and Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Custom CSS for hover effects and transform origin -->
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* 讓禁用的輸入框有更清晰的樣式 */
        input:disabled {
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
        .seat {
            transition: all 0.2s ease-in-out;
        }
        .seat:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            z-index: 10;
        }
        #seat-map-container {
            transform-origin: top center;
        }
        .highlight {
            outline: 3px solid #10b981; /* A bright green outline */
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="flex flex-col lg:flex-row min-h-screen">
        
        <!-- Sidebar: Contains all controls and information -->
        <aside class="w-full lg:w-80 xl:w-96 bg-white p-6 shadow-lg lg:fixed lg:h-full lg:overflow-y-auto">
            <div class="flex flex-col h-full">
                <header class="mb-8">
                    <h1 class="text-2xl font-bold text-indigo-700">音樂會座位劃位工具</h1>
                    <p class="text-sm text-stone-500 mt-1">匯入CSV座位圖，輕鬆管理與協作。</p>
                </header>

                <div class="space-y-6 flex-grow">
                    <!-- Map Selection/Uploader Section -->
                    <div>
                        <label for="map-selector" class="block text-sm font-medium text-stone-700 mb-2">1. 選擇或匯入座位圖</label>
                        <select id="map-selector" class="w-full p-2 border border-stone-300 rounded-lg bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- 請選擇座位圖 --</option>
                            <!-- Existing maps will be populated here by JS -->
                            <option value="upload-new" class="font-bold text-indigo-600">-- 匯入新的座位圖 --</option>
                        </select>
                        <div id="file-input-container" class="hidden mt-2">
                            <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer"/>
                            <p class="text-xs text-stone-400 mt-1">此檔案定義座位圖佈局。</p>
                        </div>
                    </div>

                    <!-- Status File Uploader Section -->
                    <div>
                        <label for="status-file-input" class="block text-sm font-medium text-stone-700 mb-2">2. 匯入預設狀態 (選填)</label>
                        <input type="file" id="status-file-input" accept=".csv" class="block w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer" disabled/>
                        <p class="text-xs text-stone-400 mt-1">格式: `座位ID,狀態,備註`。</p>
                    </div>

                    <!-- Search Section -->
                    <div>
                        <label for="search-input" class="block text-sm font-medium text-stone-700 mb-2">3. 搜尋座位</label>
                        <input type="search" id="search-input" placeholder="輸入座位ID或備註關鍵字..." class="w-full p-2 border border-stone-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Statistics Display Section -->
                    <div id="stats-container" class="hidden">
                        <h2 class="text-sm font-medium text-stone-700 mb-2">4. 座位狀態總覽</h2>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-slate-100 p-3 rounded-lg">
                                <div id="unused-count" class="text-2xl font-bold text-slate-600">0</div>
                                <div class="text-xs font-medium text-slate-500">未使用</div>
                            </div>
                            <div class="bg-stone-100 p-3 rounded-lg">
                                <div id="unavailable-count" class="text-2xl font-bold text-stone-600">0</div>
                                <div class="text-xs font-medium text-stone-500">暫不開放</div>
                            </div>
                            <div class="bg-amber-100 p-3 rounded-lg">
                                <div id="reserved-count" class="text-2xl font-bold text-amber-600">0</div>
                                <div class="text-xs font-medium text-amber-500">已預排</div>
                            </div>
                            <div class="bg-emerald-100 p-3 rounded-lg">
                                <div id="claimed-count" class="text-2xl font-bold text-emerald-600">0</div>
                                <div class="text-xs font-medium text-emerald-500">已取票</div>
                            </div>
                        </div>
                    </div>

                    <!-- Legend Section -->
                    <div>
                        <h3 class="text-sm font-medium text-stone-700 mb-2">圖例</h3>
                        <div class="flex flex-wrap gap-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-5 h-5 rounded bg-slate-400"></div>
                                <span class="text-sm">未使用</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-5 h-5 rounded bg-rose-400"></div>
                                <span class="text-sm">輪椅席 (W)</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-5 h-5 rounded bg-sky-400"></div>
                                <span class="text-sm">陪同席 (C)</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-5 h-5 rounded bg-amber-400"></div>
                                <span class="text-sm">已預排</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-5 h-5 rounded bg-emerald-500"></div>
                                <span class="text-sm">已取票</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-5 h-5 rounded bg-stone-500"></div>
                                <span class="text-sm">暫不開放</span>
                            </div>
                             <div class="flex items-center space-x-2">
                                <div class="w-5 h-5 rounded-sm bg-stone-200"></div>
                                <span class="text-sm">走道</span>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Controls -->
                    <div id="admin-controls" class="pt-4 mt-4 border-t">
                        <h3 class="text-sm font-medium text-stone-700 mb-2">管理員控制</h3>
                        <div class="space-y-4">
                             <div>
                                <button id="reset-map-button" class="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 disabled:bg-red-300 disabled:cursor-not-allowed" disabled>
                                    重設雲端狀態
                                </button>
                                <p class="text-xs text-stone-400 mt-1">將此座位圖的所有狀態還原為初始值。</p>
                            </div>
                            <div>
                                <button id="export-status-button" class="w-full py-2 px-4 bg-sky-500 text-white font-semibold rounded-lg shadow-md hover:bg-sky-600 disabled:bg-sky-300 disabled:cursor-not-allowed" disabled>
                                    匯出目前狀態
                                </button>
                                <p class="text-xs text-stone-400 mt-1">將雲端上最新的座位狀態匯出成 CSV 檔案。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Firebase Info -->
                <div class="mt-auto pt-4 border-t border-stone-200">
                    <p class="text-xs text-stone-400">
                        協作功能由 Firebase 提供。
                    </p>
                </div>
            </div>
        </aside>

        <!-- Main Content: Displays the seat map -->
        <main class="w-full lg:ml-80 xl:ml-96 p-4 sm:p-6 lg:p-8">
            <div class="w-full min-h-full bg-white rounded-xl shadow-md p-4 flex flex-col items-center justify-center overflow-hidden">
                <div id="stage-indicator" class="w-1/2 bg-stone-700 text-white text-center py-2 rounded-t-lg mb-4 hidden">
                    舞 台
                </div>
                <!-- Zoom controls for seat map (hidden until a file is loaded) -->
                <div id="zoom-controls" class="fixed bottom-4 right-4 z-20 bg-white/80 backdrop-blur-sm p-2 rounded-lg shadow-lg flex items-center space-x-2 hidden">
                    <button id="zoom-out" class="w-8 h-8 rounded-full bg-indigo-500 text-white font-bold flex items-center justify-center">-</button>
                    <span id="zoom-level" class="text-sm font-medium w-10 text-center">100%</span>
                    <button id="zoom-in" class="w-8 h-8 rounded-full bg-indigo-500 text-white font-bold flex items-center justify-center">+</button>
                </div>
                <!-- Seat map container, allows for scaling and overflow scrolling -->
                <div id="seat-map-container" class="w-full overflow-auto flex-grow flex items-center justify-center">
                    <div id="seat-map" class="grid gap-1">
                        <!-- Placeholder content before a file is loaded -->
                        <div id="placeholder" class="text-center text-stone-500 p-10">
                            <svg class="mx-auto h-12 w-12 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-stone-900">沒有座位圖</h3>
                            <p class="mt-1 text-sm text-stone-500">請從左側面板匯入一個 CSV 檔案開始。</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="tooltip" class="hidden absolute z-30 p-2 text-sm text-white bg-black rounded-md shadow-lg"></div>

    <script src="firebase-config.js"></script>
    <script type="module">
        // ==================================================================
        // Firebase 設定 (請替換成您自己的專案設定)
        // ==================================================================
        // 匯入 Firebase v9+ 模組化 SDK 所需的函式
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js"; // Use a specific version
        import { getFirestore, collection, doc, onSnapshot, runTransaction, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', async () => {
            // ==================================================================
            // DOM 元素參照
            // ==================================================================
            const fileInput = document.getElementById('csv-file-input');
            const mapSelector = document.getElementById('map-selector');
            const fileInputContainer = document.getElementById('file-input-container');
            const resetButton = document.getElementById('reset-map-button');
            const exportButton = document.getElementById('export-status-button');
            const statusFileInput = document.getElementById('status-file-input');
            const searchInput = document.getElementById('search-input');
            const seatMap = document.getElementById('seat-map');
            const placeholder = document.getElementById('placeholder');
            const statsContainer = document.getElementById('stats-container');
            const stageIndicator = document.getElementById('stage-indicator');
            const zoomControls = document.getElementById('zoom-controls');
            const zoomInButton = document.getElementById('zoom-in');
            const zoomOutButton = document.getElementById('zoom-out');
            const zoomLevelDisplay = document.getElementById('zoom-level');
            const seatMapContainer = document.getElementById('seat-map-container');
            const tooltip = document.getElementById('tooltip');

            // ==================================================================
            // 應用程式狀態
            // ==================================================================
            let appState = {
                seats: [],
                grid: [],
                maxCols: 0,
                zoomLevel: 1.0,
                mapId: null,
                accessLevel: 'view',
                searchTerm: '',
                firestoreUnsubscribe: null,
            };

            // ==================================================================
            // 常數與設定
            // ==================================================================
            const seatStatus = ['unused', 'reserved', 'claimed', 'unavailable'];
            const statusColors = {
                'unused-regular': 'bg-slate-400 hover:bg-slate-500',
                'unused-wheelchair': 'bg-rose-400 hover:bg-rose-500',
                'unused-companion': 'bg-sky-400 hover:bg-sky-500',
                reserved: 'bg-amber-400 hover:bg-amber-500',
                claimed: 'bg-emerald-500 hover:bg-emerald-600',
                unavailable: 'bg-stone-500 hover:bg-stone-600',
            };

            // ==================================================================
            // 事件監聽器
            // ==================================================================
            mapSelector.addEventListener('change', handleMapSelection);
            fileInput.addEventListener('change', handleFileSelect);
            resetButton.addEventListener('click', handleResetMap);
            exportButton.addEventListener('click', handleExportStatus);
            statusFileInput.addEventListener('change', handleStatusFileSelect);
            searchInput.addEventListener('input', handleSearch);
            seatMap.addEventListener('click', handleSeatClick);
            seatMap.addEventListener('mouseover', handleSeatMouseover);
            seatMap.addEventListener('mouseout', handleSeatMouseout);
            seatMap.addEventListener('mousemove', handleSeatMousemove);
            zoomInButton.addEventListener('click', () => updateZoom(0.1));
            zoomOutButton.addEventListener('click', () => updateZoom(-0.1));
            window.addEventListener('hashchange', handleHashChange);

            // ==================================================================
            // 初始化
            // ==================================================================
            await initializeApp();

            // ==================================================================
            // 函式定義
            // ==================================================================

            async function initializeApp() {
                try {
                    console.log("Initializing app and fetching seat maps...");
                    const mapsCollectionRef = collection(db, 'seat-maps');
                    const querySnapshot = await getDocs(mapsCollectionRef);
                    console.log(`Found ${querySnapshot.size} seat map(s) in Firestore.`);

                    const uploadOption = mapSelector.querySelector('option[value="upload-new"]');

                    querySnapshot.forEach((doc) => {
                        const mapId = doc.id;
                        if (!mapSelector.querySelector(`option[value="${mapId}"]`)) {
                            const option = document.createElement('option');
                            option.value = mapId;
                            option.textContent = mapId;
                            mapSelector.insertBefore(option, uploadOption);
                        }
                    });

                    handleHashChange();
                } catch (error) {
                    console.error("初始化應用程式失敗:", error);
                    alert("無法從雲端獲取座位圖列表。請檢查您的 Firebase 設定和網路連線。");
                    resetView();
                }
            }

            function handleHashChange() {
                console.log(`Hash changed to: ${window.location.hash}`);
                const hashParts = window.location.hash.substring(1).split('/');
                const mapIdFromHash = hashParts[0];
                const accessModeFromHash = hashParts[1];
                const newAccessLevel = (accessModeFromHash === 'edit') ? 'edit' : 'view';

                if (mapIdFromHash && mapIdFromHash !== appState.mapId) {
                    if (mapSelector.querySelector(`option[value="${mapIdFromHash}"]`)) {
                        mapSelector.value = mapIdFromHash;
                        handleMapSelection({ target: { value: mapIdFromHash } });
                    }
                } else if (mapIdFromHash === appState.mapId) {
                    if (newAccessLevel !== appState.accessLevel) {
                        console.log(`Access level changed to: ${newAccessLevel}`);
                        appState.accessLevel = newAccessLevel;
                        setUIMode();
                        renderSeatMap();
                    }
                } else {
                    resetView();
                }
            }

            async function handleMapSelection(event) {
                const selectedMapId = event.target.value;
                if (!selectedMapId) {
                    resetView();
                    return;
                }

                console.log(`Map selected: ${selectedMapId}`);
                if (appState.firestoreUnsubscribe) {
                    appState.firestoreUnsubscribe();
                }

                fileInputContainer.classList.add('hidden');
                appState.mapId = selectedMapId;
                
                const hashParts = window.location.hash.substring(1).split('/');
                appState.accessLevel = (hashParts[1] === 'edit') ? 'edit' : 'view';

                appState.grid = [];
                appState.seats = [];
                
                await setupFirestoreListener();
            }

            async function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (appState.firestoreUnsubscribe) {
                    appState.firestoreUnsubscribe();
                }
                const newMapId = file.name.replace(/\.csv$/i, "").replace(/\s+/g, "-");

                const mapDocRef = doc(db, 'seat-maps', newMapId);
                const docSnap = await getDoc(mapDocRef);

                if (docSnap.exists()) {
                    const choice = confirm(`名為 "${newMapId}" 的座位圖已存在。您想要覆蓋它嗎？`);
                    if (!choice) {
                        mapSelector.value = newMapId;
                        window.location.hash = `${newMapId}/view`;
                        return;
                    }
                }
                
                appState.mapId = newMapId;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    parseCSV(text);

                    let option = mapSelector.querySelector(`option[value="${appState.mapId}"]`);
                    if (!option) {
                        option = document.createElement('option');
                        option.value = appState.mapId;
                        option.textContent = appState.mapId;
                        mapSelector.insertBefore(option, mapSelector.querySelector('option[value="upload-new"]'));
                    }
                    mapSelector.value = appState.mapId;
                    fileInputContainer.classList.add('hidden');

                    try {
                        const gridForFirestore = Object.assign({}, appState.grid);
                        await setDoc(mapDocRef, { 
                            seats: appState.seats,
                            grid: gridForFirestore,
                            maxCols: appState.maxCols,
                            createdAt: new Date(),
                        });
                        console.log("地圖已成功上傳至 Firestore。");
                        window.location.hash = `${appState.mapId}/edit`;
                    } catch (error) {
                        console.error("上傳地圖失敗:", error);
                        alert(`上傳地圖時發生錯誤。\n${error}`);
                    }
                };
                reader.readAsText(file);
            }

            function handleSearch(event) {
                appState.searchTerm = event.target.value.trim();
                updateSearchResults();
            }

            function updateSearchResults() {
                const searchTerm = appState.searchTerm.toLowerCase();
                if (!searchTerm) {
                    document.querySelectorAll('.seat.highlight').forEach(el => el.classList.remove('highlight'));
                    return;
                }

                appState.seats.forEach(seat => {
                    const seatDiv = seatMap.querySelector(`[data-id="${seat.id}"]`);
                    if (!seatDiv) return;

                    const matchesId = seat.id.toLowerCase().includes(searchTerm);
                    const matchesNote = seat.note && seat.note.toLowerCase().includes(searchTerm);

                    if (matchesId || matchesNote) {
                        seatDiv.classList.add('highlight');
                    } else {
                        seatDiv.classList.remove('highlight');
                    }
                });
            }

            async function handleResetMap() {
                if (!appState.mapId) return;
                if (!confirm(`確定要重設地圖 "${appState.mapId}" 的雲端狀態嗎？`)) return;

                try {
                    const mapDocRef = doc(db, 'seat-maps', appState.mapId);
                    const freshSeats = appState.seats.map(seat => ({ ...seat, status: 'unused', note: '' }));
                    await setDoc(mapDocRef, { seats: freshSeats }, { merge: true });
                    alert('雲端狀態已成功重設！');
                } catch (error) {
                    console.error("重設失敗:", error);
                    alert("重設雲端狀態時發生錯誤。");
                }
            }

            async function handleStatusFileSelect(event) {
                const file = event.target.files[0];
                if (!file || !appState.mapId) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const updates = parseStatusCSV(text);
                    if (updates.length === 0) {
                        alert("狀態檔案中未找到有效的狀態更新。");
                        statusFileInput.value = '';
                        return;
                    }

                    if (!confirm(`您確定要從檔案匯入 ${updates.length} 筆狀態更新嗎？`)) {
                        statusFileInput.value = '';
                        return;
                    }

                    const mapDocRef = doc(db, 'seat-maps', appState.mapId);

                    try {
                        await runTransaction(db, async (transaction) => {
                            const docSnap = await transaction.get(mapDocRef);
                            if (!docSnap.exists()) throw "座位圖文件不存在於雲端。";

                            const seats = docSnap.data().seats;
                            const updatesMap = new Map(updates.map(u => [u.id, { status: u.status, note: u.note }]));

                            const updatedSeats = seats.map(seat => {
                                if (updatesMap.has(seat.id)) {
                                    const update = updatesMap.get(seat.id);
                                    return { ...seat, status: update.status, note: update.note !== undefined ? update.note : seat.note };
                                }
                                return seat;
                            });

                            transaction.update(mapDocRef, { seats: updatedSeats });
                        });
                        alert("預設狀態已成功匯入並更新至雲端。");
                    } catch (error) {
                        console.error("匯入狀態失敗:", error);
                        alert(`匯入狀態時發生錯誤: ${error}`);
                    } finally {
                        statusFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            }

            function handleExportStatus() {
                if (!appState.mapId || appState.seats.length === 0) return;

                const header = "seat_id,status,note\n";
                const csvRows = appState.seats.map(seat => `${seat.id},${seat.status},"${seat.note || ''}"`);
                const csvContent = header + csvRows.join('\n');

                const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });

                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, "");
                link.setAttribute("download", `status-export-${appState.mapId}-${timestamp}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function parseStatusCSV(csvText) {
                const normalizedCsvText = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                const rows = normalizedCsvText.split('\n').filter(row => row.trim() !== '');
                const updates = [];
                const validStatuses = new Set(seatStatus);

                rows.forEach(row => {
                    const [id, status, note] = row.split(',');
                    if (id && status && validStatuses.has(status.trim())) {
                        updates.push({ id: id.trim(), status: status.trim(), note: note ? note.trim() : '' });
                    }
                });
                return updates;
            }

            function parseCSV(csvText) {
                const normalizedCsvText = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                const rows = normalizedCsvText.split('\n').filter(row => row.trim() !== '').map(row => row.split(','));

                appState.seats = [];
                appState.grid = [];
                let maxCols = 0;
                let currentRowLabel = '';
                const uniqueSeats = new Set();

                rows.forEach(row => {
                    let gridRow = [];
                    row.forEach(cell => {
                        const content = cell.trim();
                        if (content.includes('排')) {
                            currentRowLabel = content.replace('排', '');
                            gridRow.push({ type: 'label', text: content.replace('排', '') });
                        } else if (content.match(/^[WC]\d+$/i)) {
                            const seatId = content;
                            if (!uniqueSeats.has(seatId)) {
                                uniqueSeats.add(seatId);
                                const seatType = content.charAt(0).toUpperCase() === 'W' ? 'wheelchair' : 'companion';
                                appState.seats.push({ id: seatId, row: currentRowLabel, number: content, type: seatType, status: 'unused', note: '' });
                                gridRow.push({ type: 'seat', id: seatId });
                            } else {
                                gridRow.push({ type: 'aisle' });
                            }
                        } else if (!isNaN(parseInt(content)) && content.length < 4) {
                            const seatNumber = content;
                            const seatId = `${currentRowLabel}-${seatNumber}`;
                            if (!uniqueSeats.has(seatId)) {
                                uniqueSeats.add(seatId);
                                appState.seats.push({ id: seatId, row: currentRowLabel, number: seatNumber, type: 'regular', status: 'unused', note: '' });
                                gridRow.push({ type: 'seat', id: seatId });
                            } else {
                                gridRow.push({ type: 'aisle' });
                            }
                        } else {
                            gridRow.push({ type: 'aisle' });
                        }
                    });
                    appState.grid.push(gridRow);
                    if (row.length > maxCols) {
                        maxCols = row.length;
                    }
                });
                appState.maxCols = maxCols;
            }

            function renderSeatMap() {
                console.log("Starting renderSeatMap()...");
                seatMap.innerHTML = '';
                seatMap.style.gridTemplateColumns = `repeat(${appState.maxCols}, minmax(0, 1fr))`;

                appState.grid.forEach((row) => {
                    row.forEach((cell) => {
                        const cellDiv = document.createElement('div');
                        cellDiv.className = 'flex items-center justify-center text-[0.6rem] w-5 h-5 rounded';
                        
                        if (cell.type === 'seat') {
                            const seatData = appState.seats.find(s => s.id === cell.id);
                            if (seatData) {
                                cellDiv.classList.add('seat', 'text-white', 'font-semibold');
                                if (appState.accessLevel === 'edit') {
                                    cellDiv.classList.add('cursor-pointer');
                                }
                                cellDiv.textContent = seatData.number;
                                cellDiv.dataset.id = seatData.id;
                                updateSeatColor(cellDiv, seatData);
                            } else {
                                console.error(`Data mismatch: Seat with ID "${cell.id}" found in grid but not in seats array.`);
                                cellDiv.classList.add('bg-red-800');
                                cellDiv.textContent = '?';
                            }
                        } else if (cell.type === 'aisle') {
                            cellDiv.classList.add('bg-stone-200', 'rounded-sm');
                        } else if (cell.type === 'label') {
                             cellDiv.classList.add('text-stone-500', 'font-bold', 'w-auto');
                             cellDiv.textContent = cell.text;
                        }
                        seatMap.appendChild(cellDiv);
                    });
                });
                updateSearchResults();
                console.log("Finished renderSeatMap().");
            }

            async function setupFirestoreListener() {
                if (!appState.mapId) return;

                if (appState.firestoreUnsubscribe) {
                    appState.firestoreUnsubscribe();
                }

                const mapDocRef = doc(db, 'seat-maps', appState.mapId);

                appState.firestoreUnsubscribe = onSnapshot(mapDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.grid) {
                            appState.grid = Object.values(data.grid);
                            appState.maxCols = data.maxCols;
                        }
                        appState.seats = data.seats;
                        renderSeatMap();
                        updateUIOnLoad();
                        updateStats();
                    } else {
                        resetView();
                    }
                }, (error) => {
                    console.error("Firestore listener error: ", error);
                    alert("無法連接到協作服務。");
                });
            }

            async function handleSeatClick(event) {
                if (appState.accessLevel !== 'edit') return;
                const seatDiv = event.target.closest('.seat');
                if (!seatDiv) return;

                const seatId = seatDiv.dataset.id;
                const mapDocRef = doc(db, 'seat-maps', appState.mapId);

                try {
                    await runTransaction(db, async (transaction) => {
                        const docSnap = await transaction.get(mapDocRef);
                        if (!docSnap.exists()) throw "文件不存在！";

                        const seats = docSnap.data().seats;
                        const seatIndex = seats.findIndex(s => s.id === seatId);
                        if (seatIndex === -1) throw `在 Firestore 文件中找不到座位 ${seatId}。`;

                        const seat = seats[seatIndex];
                        const currentStatusIndex = seatStatus.indexOf(seat.status);
                        seat.status = seatStatus[(currentStatusIndex + 1) % seatStatus.length];
                        
                        transaction.update(mapDocRef, { seats: seats });
                    });
                } catch (e) {
                    console.error("Transaction 失敗: ", e);
                }
            }

            function handleSeatMouseover(event) {
                const seatDiv = event.target.closest('.seat');
                if (!seatDiv) return;
                const seatId = seatDiv.dataset.id;
                const seatData = appState.seats.find(s => s.id === seatId);
                if (seatData && seatData.note) {
                    tooltip.textContent = seatData.note;
                    tooltip.classList.remove('hidden');
                }
            }

            function handleSeatMouseout(event) {
                tooltip.classList.add('hidden');
            }

            function handleSeatMousemove(event) {
                tooltip.style.left = `${event.pageX + 10}px`;
                tooltip.style.top = `${event.pageY + 10}px`;
            }

            function updateSeatColor(element, seatData) {
                element.className = element.className.replace(/\bbg-\w+-\d{2,3}\b/g, '').replace(/\bhover:bg-\w+-\d{2,3}\b/g, '');
                let colorClass = '';
                if (seatData.status === 'unused') {
                    if (seatData.type === 'wheelchair') {
                        colorClass = statusColors['unused-wheelchair'];
                    } else if (seatData.type === 'companion') {
                        colorClass = statusColors['unused-companion'];
                    } else {
                        colorClass = statusColors['unused-regular'];
                    }
                } else {
                    colorClass = statusColors[seatData.status];
                }
                colorClass.split(' ').forEach(cls => element.classList.add(cls));
            }

            function updateStats() {
                const counts = appState.seats.reduce((acc, seat) => {
                    acc[seat.status] = (acc[seat.status] || 0) + 1;
                    return acc;
                }, {});
                document.getElementById('unused-count').textContent = counts.unused || 0;
                document.getElementById('reserved-count').textContent = counts.reserved || 0;
                document.getElementById('claimed-count').textContent = counts.claimed || 0;
                document.getElementById('unavailable-count').textContent = counts.unavailable || 0;
            }

            function setUIMode() {
                const isEditMode = appState.accessLevel === 'edit';
                resetButton.disabled = !isEditMode;
                statusFileInput.disabled = !isEditMode;
                exportButton.disabled = !appState.mapId;
                const adminControls = document.getElementById('admin-controls');
                if(adminControls) adminControls.style.display = isEditMode ? 'block' : 'none';
            }
            
            function updateUIOnLoad() {
                placeholder.classList.add('hidden');
                statsContainer.classList.remove('hidden');
                stageIndicator.classList.remove('hidden');
                zoomControls.classList.remove('hidden');
                setUIMode();
            }

            function updateZoom(amount) {
                appState.zoomLevel += amount;
                appState.zoomLevel = Math.max(0.5, Math.min(appState.zoomLevel, 2.0));
                seatMapContainer.style.transform = `scale(${appState.zoomLevel})`;
                zoomLevelDisplay.textContent = `${Math.round(appState.zoomLevel * 100)}%`;
            }

            function resetView() {
                if (appState.firestoreUnsubscribe) {
                    appState.firestoreUnsubscribe();
                }
                appState.mapId = null;
                appState.seats = [];
                appState.grid = [];
                appState.zoomLevel = 1.0;
                appState.searchTerm = '';
                searchInput.value = '';

                seatMap.innerHTML = '';
                seatMap.appendChild(placeholder);
                placeholder.classList.remove('hidden');
                
                statsContainer.classList.add('hidden');
                stageIndicator.classList.add('hidden');
                zoomControls.classList.add('hidden');
                fileInputContainer.classList.add('hidden');

                setUIMode();

                seatMapContainer.style.transform = 'scale(1.0)';
                zoomLevelDisplay.textContent = '100%';
            }
        });
    </script>
</body>
</html>